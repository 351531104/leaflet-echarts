(function(a,b){if(typeof define==="function"&&define.amd){define(["leaflet"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("leaflet"))}else{if(typeof a!=="undefined"&&a.L){a.L.echartsLayer=b(L)}}}}(this,function(a){a.EchartsLayer=a.Class.extend({includes:[a.Mixin.Events],_echartsContainer:null,_map:null,_ec:null,_option:null,_geoCoord:[],_mapOffset:[0,0],_delta:0,_startTime:null,_lastMousePos:null,initialize:function(d,b){this._map=d;d.scrollWheelZoom.disable();var c=d.getSize();var e=this._echartsContainer=document.createElement("div");e.style.position="absolute";e.style.height=c.y+"px";e.style.width=c.x+"px";e.style.top=0;e.style.left=0;d.getPanes().overlayPane.appendChild(e);this._init(d,b)},_init:function(f,d){var b=this;b._map=f;b.getEchartsContainer=function(){return b._echartsContainer};b.getMap=function(){return b._map};b.geoCoord2Pixel=function(j){var h=new a.latLng(j[1],j[0]);var i=b._map.latLngToContainerPoint(h);return[i.x,i.y]};b.pixel2GeoCoord=function(i){var h=b._map.containerPointToLatLng(a.point(i[0],i[1]));return[h.lng,h.lat]};b.initECharts=function(){b._ec=d.init.apply(b,arguments);b._bindEvent();b._addMarkWrap();return b._ec};b._addMarkWrap=function(){function h(n,o,m){var l;if(m=="markPoint"){var l=o.data;if(l&&l.length){for(var j=0,i=l.length;j<i;j++){if(!(l[j].name&&this._geoCoord.hasOwnProperty(l[j].name))){l[j].name=j+"markp";b._geoCoord[l[j].name]=l[j].geoCoord}b._AddPos(l[j])}}}else{l=o.data;if(l&&l.length){for(var j=0,i=l.length;j<i;j++){if(!(l[j][0].name&&this._geoCoord.hasOwnProperty(l[j][0].name))){l[j][0].name=j+"startp";b._geoCoord[l[j][0].name]=l[j][0].geoCoord}if(!(l[j][1].name&&this._geoCoord.hasOwnProperty(l[j][1].name))){l[j][1].name=j+"endp";b._geoCoord[l[j][1].name]=l[j][1].geoCoord}b._AddPos(l[j][0]);b._AddPos(l[j][1])}}}b._ec._addMarkOri(n,o,m)}b._ec._addMarkOri=b._ec._addMark;b._ec._addMark=h};b.getECharts=function(){return b._ec};b.getMapOffset=function(){return b._mapOffset};b.setOption=function(o,p){b._option=o;var m=o.series||{};for(var n=0,s;s=m[n++];){var r=s.geoCoord;if(r){for(var j in r){b._geoCoord[j]=r[j]}}}for(var n=0,s;s=m[n++];){var t=s.markPoint||{};var h=s.markLine||{};var l=t.data;if(l&&l.length){for(var j=0,q=l.length;j<q;j++){if(!(l[j].name&&this._geoCoord.hasOwnProperty(l[j].name))){l[j].name=j+"markp";b._geoCoord[l[j].name]=l[j].geoCoord}b._AddPos(l[j])}}l=h.data;if(l&&l.length){for(var j=0,q=l.length;j<q;j++){if(!(l[j][0].name&&this._geoCoord.hasOwnProperty(l[j][0].name))){l[j][0].name=j+"startp";b._geoCoord[l[j][0].name]=l[j][0].geoCoord}if(!(l[j][1].name&&this._geoCoord.hasOwnProperty(l[j][1].name))){l[j][1].name=j+"endp";b._geoCoord[l[j][1].name]=l[j][1].geoCoord}b._AddPos(l[j][0]);b._AddPos(l[j][1])}}}b._ec.setOption(o,p)};b._AddPos=function(h){var j=b._geoCoord[h.name];var i=b.geoCoord2Pixel(j);h.x=i[0];h.y=i[1]};b._bindEvent=function(){b._map.on("move",c("moving"));b._map.on("moveend",c("moveend"));b._map.on("zoomend",g);b._ec.getZrender().on("dragstart",e(true));b._ec.getZrender().on("dragend",e(false));b._ec.getZrender().on("mousewheel",function(j){b._ec.clear();b._lastMousePos=b._map.mouseEventToContainerPoint(j.event);var k=a.DomEvent.getWheelDelta(j.event);var i=b._map,h=i.getZoom();k=k>0?Math.ceil(k):Math.floor(k);k=Math.max(Math.min(k,4),-4);k=i._limitZoom(h+k)-h;b._delta=0;b._startTime=null;if(!k){return}if(i.options.scrollWheelZoom==="center"){i.setZoom(h+k)}else{i.setZoomAround(b._lastMousePos,h+k)}return function(){}})};function g(){b.setOption(b._option)}function c(h){return function(){var i=b._map._getMapPanePos();b._mapOffset=[-parseInt(i.x)||0,-parseInt(i.y)||0];b._echartsContainer.style.left=b._mapOffset[0]+"px";b._echartsContainer.style.top=b._mapOffset[1]+"px";if(h=="moving"){b._ec.clear()}if(h=="moveend"){b.setOption(b._option)}}}function e(h){return function(){var i=h?"disable":"enable";if(h){b._ec.clear()}else{b.setOption(b._option)}b._map.dragging[i]()}}}});a.echartsLayer=function(c,b){return new a.EchartsLayer(c,b)};return a.echartsLayer}));