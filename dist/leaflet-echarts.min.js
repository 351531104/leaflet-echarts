(function(a,b){if(typeof define==="function"&&define.amd){define(["leaflet"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("leaflet"))}else{if(typeof a!=="undefined"&&a.L){a.L.echartsLayer=b(L)}}}}(this,function(a){a.EchartsLayer=a.Class.extend({includes:[a.Mixin.Events],_echartsContainer:null,_map:null,_ec:null,_option:null,_geoCoord:[],_mapOffset:[0,0],_delta:0,_startTime:null,_lastMousePos:null,initialize:function(d,b){this._map=d;d.scrollWheelZoom.disable();var c=d.getSize();var e=this._echartsContainer=document.createElement("div");e.style.position="absolute";e.style.height=c.y+"px";e.style.width=c.x+"px";e.style.top=0;e.style.left=0;d.getPanes().overlayPane.appendChild(e);this._init(d,b)},_init:function(g,e){var c=this;c._map=g;c.getEchartsContainer=function(){return c._echartsContainer};c.getMap=function(){return c._map};c.geoCoord2Pixel=function(k){var i=new a.latLng(k[1],k[0]);var j=c._map.latLngToContainerPoint(i);return[j.x,j.y]};c.pixel2GeoCoord=function(j){var i=c._map.containerPointToLatLng(a.point(j[0],j[1]));return[i.lng,i.lat]};c.initECharts=function(){c._ec=e.init.apply(c,arguments);c._bindEvent();c._addMarkWrap();return c._ec};c._addMarkWrap=function(){function i(o,p,n){var m;if(n=="markPoint"){var m=p.data;if(m&&m.length){for(var l=0,j=m.length;l<j;l++){if(!(m[l].name&&this._geoCoord.hasOwnProperty(m[l].name))){m[l].name=l+"markp";c._geoCoord[m[l].name]=m[l].geoCoord}c._AddPos(m[l])}}}else{m=p.data;if(m&&m.length){for(var l=0,j=m.length;l<j;l++){if(!(m[l][0].name&&this._geoCoord.hasOwnProperty(m[l][0].name))){m[l][0].name=l+"startp";c._geoCoord[m[l][0].name]=m[l][0].geoCoord}if(!(m[l][1].name&&this._geoCoord.hasOwnProperty(m[l][1].name))){m[l][1].name=l+"endp";c._geoCoord[m[l][1].name]=m[l][1].geoCoord}c._AddPos(m[l][0]);c._AddPos(m[l][1])}}}c._ec._addMarkOri(o,p,n)}c._ec._addMarkOri=c._ec._addMark;c._ec._addMark=i};c.getECharts=function(){return c._ec};c.getMapOffset=function(){return c._mapOffset};c.setOption=function(p,q){c._option=p;var n=p.series||{};for(var o=0,t;t=n[o++];){var s=t.geoCoord;if(s){for(var l in s){c._geoCoord[l]=s[l]}}}for(var o=0,t;t=n[o++];){var u=t.markPoint||{};var j=t.markLine||{};var m=u.data;if(m&&m.length){for(var l=0,r=m.length;l<r;l++){if(!(m[l].name&&this._geoCoord.hasOwnProperty(m[l].name))){m[l].name=l+"markp";c._geoCoord[m[l].name]=m[l].geoCoord}c._AddPos(m[l])}}m=j.data;if(m&&m.length){for(var l=0,r=m.length;l<r;l++){if(!(m[l][0].name&&this._geoCoord.hasOwnProperty(m[l][0].name))){m[l][0].name=l+"startp";c._geoCoord[m[l][0].name]=m[l][0].geoCoord}if(!(m[l][1].name&&this._geoCoord.hasOwnProperty(m[l][1].name))){m[l][1].name=l+"endp";c._geoCoord[m[l][1].name]=m[l][1].geoCoord}c._AddPos(m[l][0]);c._AddPos(m[l][1])}}}c._ec.setOption(p,q)};c._AddPos=function(i){var k=c._geoCoord[i.name];var j=c.geoCoord2Pixel(k);i.x=j[0];i.y=j[1]};c._bindEvent=function(){c._map.on("move",d("moving"));c._map.on("moveend",d("moveend"));c._map.on("zoomstart",b);c._map.on("zoomend",h);c._ec.getZrender().on("dragstart",f(true));c._ec.getZrender().on("dragend",f(false));c._ec.getZrender().on("mousewheel",function(k){c._lastMousePos=c._map.mouseEventToContainerPoint(k.event);var l=a.DomEvent.getWheelDelta(k.event);var j=c._map,i=j.getZoom();l=l>0?Math.ceil(l):Math.floor(l);l=Math.max(Math.min(l,4),-4);l=j._limitZoom(i+l)-i;c._delta=0;c._startTime=null;if(!l){return}if(j.options.scrollWheelZoom==="center"){j.setZoom(i+l)}else{j.setZoomAround(c._lastMousePos,i+l)}return function(){}})};function h(){c.setOption(c._option)}function b(){c._ec.clear()}function d(i){return function(){var j=c._map._getMapPanePos();c._mapOffset=[-parseInt(j.x)||0,-parseInt(j.y)||0];c._echartsContainer.style.left=c._mapOffset[0]+"px";c._echartsContainer.style.top=c._mapOffset[1]+"px";if(i=="moving"){c._ec.clear()}if(i=="moveend"){c.setOption(c._option)}}}function f(i){return function(){var j=i?"disable":"enable";if(i){c._ec.clear()}else{c.setOption(c._option)}c._map.dragging[j]()}}}});a.echartsLayer=function(c,b){return new a.EchartsLayer(c,b)};return a.echartsLayer}));